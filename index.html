<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Analyst Pro ‚Äî AI-Powered Product Analysis</title>
    <meta name="description"
        content="Generate comprehensive product analysis from a single prompt. Competitor research, market sizing, roadmap planning and more.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.08);
            --border-active: rgba(139, 92, 246, 0.5);
            --text-primary: #f0f0f5;
            --text-secondary: #9898a6;
            --text-muted: #5a5a6e;
            --accent: #8b5cf6;
            --accent-light: #a78bfa;
            --accent-glow: rgba(139, 92, 246, 0.15);
            --accent-2: #06b6d4;
            --accent-3: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ Background Effects ‚îÄ‚îÄ‚îÄ */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 20%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(6, 182, 212, 0.04) 0%, transparent 50%);
            z-index: -1;
            animation: bgShift 20s ease-in-out infinite alternate;
        }

        @keyframes bgShift {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-5%, -3%);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            text-align: center;
            padding: 60px 24px 40px;
            position: relative;
        }

        .header__badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            background: var(--accent-glow);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 24px;
        }

        .header__badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.8);
            }
        }

        .header h1 {
            font-size: clamp(32px, 5vw, 56px);
            font-weight: 800;
            letter-spacing: -1.5px;
            background: linear-gradient(135deg, #f0f0f5 0%, #8b5cf6 50%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
        }

        .header p {
            font-size: 17px;
            color: var(--text-secondary);
            max-width: 560px;
            margin: 0 auto;
            font-weight: 300;
        }

        /* ‚îÄ‚îÄ‚îÄ Container ‚îÄ‚îÄ‚îÄ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 24px 80px;
        }

        /* ‚îÄ‚îÄ‚îÄ Config Panel ‚îÄ‚îÄ‚îÄ */
        .config-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 24px;
            backdrop-filter: blur(20px);
        }

        .config-panel__title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 640px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group--full {
            grid-column: 1 / -1;
        }

        .provider-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .provider-row select {
            width: 180px;
            flex-shrink: 0;
        }

        .provider-row input {
            flex: 1 1 120px;
            min-width: 100px;
            width: auto;
        }

        .provider-row .btn-get-key {
            flex-shrink: 0;
            padding: 10px 14px;
            font-size: 12px;
        }

        .provider-row .btn-get-key:hover {
            color: var(--accent-light);
        }

        .provider-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .provider-links__title {
            width: 100%;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .provider-links a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--accent-light);
            background: var(--accent-glow);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-xs);
            text-decoration: none;
            transition: all 0.2s;
        }

        .provider-links a:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: var(--accent);
        }

        @media (max-width: 640px) {
            .provider-row { flex-wrap: wrap; gap: 8px; }
            .provider-row select { flex: 1 1 100%; min-width: 0; }
            .provider-row input { flex: 1 1 100%; min-width: 0; }
            .provider-row .btn-get-key { flex: 0 0 auto; }
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group label .optional {
            color: var(--text-muted);
            font-weight: 400;
            font-size: 11px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: border-color var(--transition), box-shadow var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ‚îÄ Prompt Area ‚îÄ‚îÄ‚îÄ */
        .prompt-area {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 24px;
            backdrop-filter: blur(20px);
        }

        .prompt-area textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 15px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color var(--transition), box-shadow var(--transition);
        }

        .prompt-area textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .prompt-area textarea::placeholder {
            color: var(--text-muted);
        }

        .prompt-area__hint {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .prompt-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 13px 28px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn--primary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }

        .btn--primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 28px rgba(139, 92, 246, 0.45);
        }

        .btn--primary:active {
            transform: translateY(0);
        }

        .btn--primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn--secondary {
            background: var(--bg-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn--secondary:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .btn--small {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: var(--radius-xs);
        }

        .btn--icon {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        /* ‚îÄ‚îÄ‚îÄ Progress Tracker ‚îÄ‚îÄ‚îÄ */
        .progress-tracker {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 24px;
            backdrop-filter: blur(20px);
        }

        .progress-tracker.active {
            display: block;
        }

        .progress-tracker__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .progress-tracker__title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-tracker__count {
            font-size: 13px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 100px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar__fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #06b6d4);
            border-radius: 100px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .progress-step {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 100px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            border: 1px solid transparent;
            transition: all var(--transition);
            white-space: nowrap;
        }

        .progress-step.active {
            color: var(--accent-light);
            border-color: rgba(139, 92, 246, 0.3);
            background: var(--accent-glow);
            animation: stepPulse 1.5s ease-in-out infinite;
        }

        .progress-step.done {
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.2);
            background: rgba(16, 185, 129, 0.08);
        }

        .progress-step.error {
            color: var(--danger);
            border-color: rgba(239, 68, 68, 0.2);
            background: rgba(239, 68, 68, 0.08);
        }

        @keyframes stepPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.2);
            }

            50% {
                box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.05);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Results ‚îÄ‚îÄ‚îÄ */
        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .results__toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            backdrop-filter: blur(20px);
        }

        .results__toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results__toolbar-right {
            display: flex;
            gap: 8px;
        }

        .results__toolbar h2 {
            font-size: 16px;
            font-weight: 700;
        }

        .results__toolbar .section-count {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-secondary);
            border-radius: 100px;
        }

        /* ‚îÄ‚îÄ‚îÄ Section Card ‚îÄ‚îÄ‚îÄ */
        .section-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow: hidden;
            transition: border-color var(--transition), box-shadow var(--transition);
            backdrop-filter: blur(20px);
            animation: cardSlideIn 0.4s ease both;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(16px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .section-card__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            cursor: pointer;
            user-select: none;
            transition: background var(--transition);
        }

        .section-card__header:hover {
            background: var(--bg-card-hover);
        }

        .section-card__header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .section-card__icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-xs);
            font-size: 18px;
            flex-shrink: 0;
        }

        .section-card__number {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .section-card__title {
            font-size: 15px;
            font-weight: 600;
        }

        .section-card__header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-card__chevron {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: transform var(--transition);
        }

        .section-card.expanded .section-card__chevron {
            transform: rotate(180deg);
        }

        .section-card__body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .section-card.expanded .section-card__body {
            max-height: 8000px;
        }

        .section-card__content {
            padding: 0 24px 24px;
        }

        .section-card__content .markdown-body[contenteditable="true"] {
            outline: none;
            border: 1px dashed var(--accent);
            border-radius: var(--radius-xs);
            padding: 16px;
            background: rgba(139, 92, 246, 0.03);
            cursor: text;
            position: relative;
        }

        .section-card__content .markdown-body[contenteditable="true"]:focus {
            border-color: var(--accent-light);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .section-card__edit-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--accent-light);
            margin-bottom: 8px;
            padding: 4px 10px;
            background: var(--accent-glow);
            border-radius: 100px;
            width: fit-content;
        }

        .section-card.editing .section-card__edit-indicator {
            display: inline-flex;
        }

        .section-card__actions {
            display: flex;
            gap: 8px;
            padding: 0 24px 18px;
            border-top: 1px solid var(--border);
            padding-top: 14px;
            margin-top: 8px;
        }

        /* ‚îÄ‚îÄ‚îÄ Citation Styles ‚îÄ‚îÄ‚îÄ */
        .markdown-body .citation-section {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .markdown-body .citation-section h4,
        .markdown-body .citation-section h3 {
            color: var(--accent-light);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .markdown-body a {
            color: var(--accent-light);
            text-decoration: none;
            border-bottom: 1px dotted var(--accent);
            transition: color var(--transition);
        }

        .markdown-body a:hover {
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ‚îÄ Markdown Content Styles ‚îÄ‚îÄ‚îÄ */
        .markdown-body {
            font-size: 14px;
            line-height: 1.75;
            color: var(--text-secondary);
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4 {
            color: var(--text-primary);
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .markdown-body h1 {
            font-size: 22px;
        }

        .markdown-body h2 {
            font-size: 18px;
        }

        .markdown-body h3 {
            font-size: 16px;
        }

        .markdown-body h4 {
            font-size: 14px;
        }

        .markdown-body p {
            margin-bottom: 12px;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 24px;
            margin-bottom: 12px;
        }

        .markdown-body li {
            margin-bottom: 4px;
        }

        .markdown-body strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .markdown-body em {
            color: var(--accent-light);
        }

        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 13px;
        }

        .markdown-body th {
            text-align: left;
            padding: 10px 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .markdown-body td {
            padding: 10px 14px;
            border: 1px solid var(--border);
        }

        .markdown-body blockquote {
            border-left: 3px solid var(--accent);
            padding: 8px 16px;
            margin: 12px 0;
            background: var(--accent-glow);
            border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
        }

        .markdown-body code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .markdown-body hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 20px 0;
        }

        /* ‚îÄ‚îÄ‚îÄ Edit Mode ‚îÄ‚îÄ‚îÄ */
        .section-card__editor {
            display: none;
            padding: 0 24px 24px;
        }

        .section-card.editing .section-card__content {
            display: none;
        }

        .section-card.editing .section-card__editor {
            display: block;
        }

        .section-card__editor textarea {
            width: 100%;
            min-height: 300px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            tab-size: 2;
        }

        .section-card__editor textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* ‚îÄ‚îÄ‚îÄ Loading Spinner ‚îÄ‚îÄ‚îÄ */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-light);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 13px;
            box-shadow: var(--shadow);
            animation: toastIn 0.3s ease;
            backdrop-filter: blur(20px);
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        .toast.info {
            border-left: 3px solid var(--accent-2);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Print Styles ‚îÄ‚îÄ‚îÄ */
        @media print {
            body {
                background: white;
                color: #111;
            }

            body::before {
                display: none;
            }

            .header,
            .config-panel,
            .prompt-area,
            .progress-tracker,
            .results__toolbar,
            .section-card__actions,
            .section-card__header-right,
            .btn,
            .toast-container {
                display: none !important;
            }

            .section-card {
                border: 1px solid #ddd;
                break-inside: avoid;
                background: white;
            }

            .section-card__body {
                max-height: none !important;
            }

            .section-card__content {
                display: block !important;
            }

            .section-card__editor {
                display: none !important;
            }

            .markdown-body {
                color: #333;
            }

            .markdown-body strong {
                color: #111;
            }

            .results {
                display: block !important;
            }

            .section-card__header {
                padding: 12px 16px;
            }

            .section-card__title {
                color: #111;
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Skeleton ‚îÄ‚îÄ‚îÄ */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, rgba(255, 255, 255, 0.05) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-xs);
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-line {
            height: 14px;
            margin-bottom: 10px;
        }

        .skeleton-line:nth-child(2) {
            width: 85%;
        }

        .skeleton-line:nth-child(3) {
            width: 70%;
        }

        .skeleton-line:nth-child(4) {
            width: 90%;
        }

        /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 640px) {
            .header {
                padding: 40px 16px 24px;
            }

            .container {
                padding: 0 16px 60px;
            }

            .config-panel,
            .prompt-area,
            .section-card {
                padding: 20px;
            }

            .section-card__header {
                padding: 14px 18px;
            }

            .section-card__content {
                padding: 0 18px 18px;
            }

            .section-card__actions {
                padding: 0 18px 14px;
                padding-top: 12px;
            }

            .results__toolbar {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .prompt-actions {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Q&A / Refinement ‚îÄ‚îÄ‚îÄ */
        .qa-container {
            margin-top: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            backdrop-filter: blur(20px);
            display: none;
        }

        .qa-container.active {
            display: block;
            animation: cardSlideIn 0.5s ease both;
        }

        .qa-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 700;
        }

        .qa-messages {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
            padding-right: 8px;
        }

        .qa-messages::-webkit-scrollbar {
            width: 4px;
        }

        .qa-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            line-height: 1.5;
        }

        .message--user {
            align-self: flex-end;
            background: var(--accent-glow);
            color: var(--accent-light);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-bottom-right-radius: 4px;
        }

        .message--ai {
            align-self: flex-start;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .qa-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .qa-input-wrapper textarea {
            width: 100%;
            min-height: 80px;
            padding: 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .qa-input-wrapper textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .qa-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .refining-status {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--accent-light);
            margin-bottom: 10px;
        }

        .refining-status.active {
            display: flex;
        }

        /* ‚îÄ‚îÄ‚îÄ Feature Review Modal & User Flow ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-width: 520px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
        }

        .modal__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal__title {
            font-size: 17px;
            font-weight: 700;
        }

        .modal__close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            font-size: 20px;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal__close:hover {
            color: var(--text-primary);
        }

        .modal__body {
            padding: 20px 24px;
            overflow-y: auto;
        }

        .feature-review-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .feature-review-item:last-child {
            border-bottom: none;
        }

        .feature-review-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .feature-review-item__label {
            flex: 1;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .feature-review-item.passed input:checked + .feature-review-item__label {
            color: var(--success);
        }

        .modal__footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
        }

        .user-flow-section {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .user-flow-section.active {
            display: block;
            animation: cardSlideIn 0.4s ease both;
        }

        .user-flow-section__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            cursor: pointer;
            user-select: none;
            transition: background var(--transition);
        }

        .user-flow-section__header:hover {
            background: var(--bg-card-hover);
        }

        .user-flow-section__content {
            padding: 0 24px 24px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .user-flow-section.expanded .user-flow-section__content {
            max-height: 8000px;
        }

        .user-flow-section.expanded .user-flow-section__header .section-card__chevron {
            transform: rotate(180deg);
        }

        .user-flow-section .mermaid {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin: 16px 0;
        }

        .user-flow-section .user-flow-diagram {
            min-height: 120px;
        }

        .user-flow-section__actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
    </style>
</head>

<body>

    <!-- ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ -->
    <header class="header">
        <div class="header__badge">AI-Powered Analysis</div>
        <h1>Product Analyst Pro</h1>
        <p>Generate a comprehensive product analysis from a single prompt. Competitor research, market sizing, roadmap
            planning and more.</p>
    </header>

    <div class="container">
        <!-- ‚îÄ‚îÄ‚îÄ Config Panel ‚îÄ‚îÄ‚îÄ -->
        <div class="config-panel">
            <div class="config-panel__title">‚öôÔ∏è Configuration</div>
            <div class="config-grid config-grid--ai-providers">
                <div class="form-group form-group--full">
                    <label>AI Provider (Primary)</label>
                    <div class="provider-row">
                        <select id="providerPrimary" onchange="updateGetKeyLinks()">
                            <option value="gemini" selected>Gemini (Google)</option>
                            <option value="openai">OpenAI (GPT-4o)</option>
                            <option value="grok">Grok (xAI) ‚Äî grok-3-mini</option>
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="openrouter">OpenRouter (many models)</option>
                        </select>
                        <input type="text" id="keyPrimary" placeholder="Paste API key here (Ctrl+V)" autocomplete="off">
                        <button type="button" class="btn btn--secondary btn--small btn-get-key" onclick="pasteFromClipboard('keyPrimary')">üìã Paste</button>
                        <a class="btn btn--secondary btn--small btn-get-key" id="getKeyPrimary" href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">üîë Get key</a>
                    </div>
                </div>
                <div class="form-group form-group--full">
                    <label>Fallback 1 <span class="optional">(Used if primary hits quota)</span></label>
                    <div class="provider-row">
                        <select id="providerFallback1" onchange="updateGetKeyLinks()">
                            <option value="">None</option>
                            <option value="gemini">Gemini</option>
                            <option value="openai">OpenAI</option>
                            <option value="grok">Grok</option>
                            <option value="claude">Claude</option>
                            <option value="openrouter">OpenRouter</option>
                        </select>
                        <input type="text" id="keyFallback1" placeholder="API key (optional)" autocomplete="off">
                        <button type="button" class="btn btn--secondary btn--small btn-get-key" onclick="pasteFromClipboard('keyFallback1')">üìã Paste</button>
                        <a class="btn btn--secondary btn--small btn-get-key" id="getKeyFallback1" href="#" target="_blank" rel="noopener" style="visibility:hidden;">üîë Get key</a>
                    </div>
                </div>
                <div class="form-group form-group--full">
                    <label>Fallback 2 <span class="optional">(Optional)</span></label>
                    <div class="provider-row">
                        <select id="providerFallback2" onchange="updateGetKeyLinks()">
                            <option value="">None</option>
                            <option value="gemini">Gemini</option>
                            <option value="openai">OpenAI</option>
                            <option value="grok">Grok</option>
                            <option value="claude">Claude</option>
                            <option value="openrouter">OpenRouter</option>
                        </select>
                        <input type="text" id="keyFallback2" placeholder="API key (optional)" autocomplete="off">
                        <button type="button" class="btn btn--secondary btn--small btn-get-key" onclick="pasteFromClipboard('keyFallback2')">üìã Paste</button>
                        <a class="btn btn--secondary btn--small btn-get-key" id="getKeyFallback2" href="#" target="_blank" rel="noopener" style="visibility:hidden;">üîë Get key</a>
                    </div>
                </div>
                <div class="form-group form-group--full">
                    <div class="provider-links">
                        <span class="provider-links__title">üìã Get API keys from platforms:</span>
                        <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Gemini (free)</a>
                        <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">OpenAI</a>
                        <a href="https://console.x.ai/" target="_blank" rel="noopener">Grok (xAI)</a>
                        <a href="https://console.anthropic.com/" target="_blank" rel="noopener">Claude</a>
                        <a href="https://openrouter.ai/keys" target="_blank" rel="noopener">OpenRouter</a>
                        <a href="https://serpapi.com/manage-api-key" target="_blank" rel="noopener">SerpAPI</a>
                    </div>
                </div>
                <div class="form-group">
                    <label>SerpAPI Key <span class="optional">(Optional ‚Äî for real app store data)</span></label>
                    <input type="text" id="serpKey" placeholder="Leave empty for AI-only mode" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Target Language</label>
                    <select id="targetLanguage">
                        <option value="English" selected>English üá∫üá∏</option>
                        <option value="Vietnamese">Vietnamese üáªüá≥</option>
                        <option value="Japanese">Japanese üáØüáµ</option>
                        <option value="Chinese">Chinese üá®üá≥</option>
                        <option value="Spanish">Spanish üá™üá∏</option>
                        <option value="French">French üá´üá∑</option>
                        <option value="German">German üá©üá™</option>
                        <option value="Korean">Korean üá∞üá∑</option>
                    </select>
                </div>
            </div>
            <div class="prompt-area__hint" style="margin-top:12px;font-size:11px;">
                üí° Quota exceeded? Add fallback providers (OpenAI, Grok, OpenRouter) ‚Äî the app will auto-switch when primary fails.
            </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ Prompt Area ‚îÄ‚îÄ‚îÄ -->
        <div class="prompt-area">
            <textarea id="promptInput"
                placeholder="Describe the product you want to analyze...&#10;&#10;Example: A meditation app for Gen Z with social features, gamification, and AI-personalized content. Target markets: US, UK, and Southeast Asia."></textarea>
            <div class="prompt-area__hint">
                üí° Be specific ‚Äî include target audience, key features, and target markets for best results.
            </div>
            <div class="prompt-actions">
                <button class="btn btn--primary" id="generateBtn" onclick="startAnalysis()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    Generate Analysis
                </button>
                <button class="btn btn--secondary" id="stopBtn" onclick="stopAnalysis()" style="display:none;">
                    ‚úï Stop
                </button>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ Progress Tracker ‚îÄ‚îÄ‚îÄ -->
        <div class="progress-tracker" id="progressTracker">
            <div class="progress-tracker__header">
                <div class="progress-tracker__title" id="progressTitle">Generating analysis...</div>
                <div class="progress-tracker__count" id="progressCount">0 / 11</div>
            </div>
            <div class="progress-bar">
                <div class="progress-bar__fill" id="progressFill"></div>
            </div>
            <div class="progress-steps" id="progressSteps"></div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ Results ‚îÄ‚îÄ‚îÄ -->
        <div class="results" id="results">
            <div class="results__toolbar">
                <div class="results__toolbar-left">
                    <h2>üìã Analysis Results</h2>
                    <span class="section-count" id="sectionCount">11 sections</span>
                </div>
                <div class="results__toolbar-right">
                    <button class="btn btn--secondary btn--small" onclick="expandAll()">Expand All</button>
                    <button class="btn btn--secondary btn--small" onclick="collapseAll()">Collapse All</button>
                    <button class="btn btn--secondary btn--small" onclick="exportMarkdown()">üì• Markdown</button>
                    <button class="btn btn--primary btn--small" onclick="exportWord()">üìù Word</button>
                    <button class="btn btn--secondary btn--small" onclick="exportPDF()">üìÑ PDF</button>
                </div>
            </div>
            <div id="sectionsContainer"></div>

            <!-- ‚îÄ‚îÄ‚îÄ User Flow Section (generated on demand) ‚îÄ‚îÄ‚îÄ -->
            <div class="user-flow-section" id="userFlowSection">
                <div class="user-flow-section__header" onclick="toggleUserFlowSection()">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:20px;">üîÑ</span>
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);">GENERATED FROM PASS REVIEW</div>
                            <div class="section-card__title">Product User Flow</div>
                        </div>
                    </div>
                    <div class="section-card__chevron" id="userFlowChevron">‚ñº</div>
                </div>
                <div class="user-flow-section__content" id="userFlowContent">
                    <div class="markdown-body user-flow-diagram" id="userFlowDiagram"></div>
                    <div class="user-flow-section__actions" id="userFlowActions" style="display:none;">
                        <button class="btn btn--secondary btn--small" onclick="exportUserFlowSVG()" title="Download user flow diagram as SVG (drag into Figma)">
                            üì• Export SVG for Figma
                        </button>
                        <button class="btn btn--primary btn--small" onclick="generateFigmaDesignSpec()" id="generateFigmaBtn" title="Generate Figma-ready design spec from user flow">
                            üìê Generate Figma Design
                        </button>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ Figma Design Spec Modal ‚îÄ‚îÄ‚îÄ -->
            <div class="modal-overlay" id="figmaSpecModal" onclick="if(event.target===this)closeFigmaSpecModal()">
                <div class="modal" style="max-width:720px;max-height:90vh;">
                    <div class="modal__header">
                        <span class="modal__title">üìê Figma Design Spec</span>
                        <button class="modal__close" onclick="closeFigmaSpecModal()">√ó</button>
                    </div>
                    <div class="modal__body" id="figmaSpecBody" style="overflow-y:auto;"></div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" onclick="closeFigmaSpecModal()">Close</button>
                        <button class="btn btn--primary" onclick="exportFigmaSpecHTML()">üì• Download as HTML</button>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ Feature Review Modal ‚îÄ‚îÄ‚îÄ -->
            <div class="modal-overlay" id="featureReviewModal" onclick="if(event.target===this)closeFeatureReviewModal()">
                <div class="modal">
                    <div class="modal__header">
                        <span class="modal__title">‚úì Mark Features as Pass Review</span>
                        <button class="modal__close" onclick="closeFeatureReviewModal()">√ó</button>
                    </div>
                    <div class="modal__body" id="featureReviewBody">
                        <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px;">
                            Select the features that have passed review. These will be used to generate the product user flow.
                        </p>
                        <div id="featureReviewList"></div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" onclick="closeFeatureReviewModal()">Cancel</button>
                        <button class="btn btn--primary" onclick="confirmFeatureReview()">Done</button>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ Q&A Section ‚îÄ‚îÄ‚îÄ -->
            <div class="qa-container" id="qaContainer">
                <div class="qa-header">
                    <span>üí¨</span> Smart Refinement & Q&A
                </div>

                <div class="qa-messages" id="qaMessages">
                    <div class="message message--ai">
                        Analysis complete! You can ask questions about the results or request specific edits here.
                        For example: "Add a section for marketing strategy" or "Who are the competitors in Japan?"
                    </div>
                </div>

                <div class="refining-status" id="refiningStatus">
                    <div class="spinner"></div>
                    <span>AI is refining the analysis...</span>
                </div>

                <div class="qa-input-wrapper">
                    <textarea id="qaInput" placeholder="Ask a question or request a fix..."></textarea>
                    <div class="qa-actions">
                        <button class="btn btn--primary" id="refineBtn" onclick="applyRefinement()">
                            ‚ú® Refine Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Toast Container ‚îÄ‚îÄ‚îÄ -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ‚îÄ‚îÄ‚îÄ Section Definitions ‚îÄ‚îÄ‚îÄ
        const SECTIONS = [
            { id: 'target_audience', icon: 'üéØ', title: 'Target Audience & User Personas', color: '#8b5cf6' },
            { id: 'competitor_list', icon: 'üèÜ', title: 'Competitor List (App Store & Google Play)', color: '#06b6d4' },
            { id: 'competitor_analysis', icon: 'üìä', title: 'Competitor Deep-Dive Analysis', color: '#3b82f6' },
            { id: 'market_potential', icon: 'üìà', title: 'Market Potential (TAM / SAM / SOM)', color: '#10b981' },
            { id: 'uvp', icon: 'üí°', title: 'Unique Value Proposition', color: '#f59e0b' },
            { id: 'swot', icon: 'üîç', title: 'SWOT Analysis', color: '#ef4444' },
            { id: 'features', icon: '‚öôÔ∏è', title: 'Product Features', color: '#8b5cf6' },
            { id: 'monetization', icon: 'üí∞', title: 'Monetization Strategy', color: '#10b981' },
            { id: 'kpis', icon: 'üìã', title: 'Key Metrics & KPIs', color: '#06b6d4' },
            { id: 'roadmap', icon: 'üó∫Ô∏è', title: 'Product Roadmap', color: '#3b82f6' },
            { id: 'risks', icon: '‚ö†Ô∏è', title: 'Risk Assessment', color: '#f59e0b' }
        ];

        // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
        let analysisData = {};
        let abortController = null;
        let isGenerating = false;
        let providerConfig = [];  // [{ provider, keys }] in priority order
        let currentProviderIndex = 0;
        let currentKeyIndex = 0;
        let featuresPassedReview = [];  // Array of feature names marked as pass review
        let userFlowData = null;       // { mermaid, description } from last user flow generation

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        // ‚îÄ‚îÄ‚îÄ Build provider config from UI ‚îÄ‚îÄ‚îÄ
        function buildProviderConfig() {
            const config = [];
            const add = (providerId, keyId) => {
                const p = document.getElementById(providerId)?.value;
                const k = (document.getElementById(keyId)?.value || '').trim();
                if (p && k) config.push({ provider: p, keys: k.split(',').map(x => x.trim()).filter(Boolean) });
            };
            add('providerPrimary', 'keyPrimary');
            add('providerFallback1', 'keyFallback1');
            add('providerFallback2', 'keyFallback2');
            return config;
        }

        const PROVIDER_KEY_URLS = {
            gemini: 'https://aistudio.google.com/apikey',
            openai: 'https://platform.openai.com/api-keys',
            grok: 'https://console.x.ai/',
            claude: 'https://console.anthropic.com/',
            openrouter: 'https://openrouter.ai/keys'
        };

        async function pasteFromClipboard(inputId) {
            const el = document.getElementById(inputId);
            if (!el) return;
            try {
                const text = await navigator.clipboard.readText();
                el.value = text.trim();
                el.focus();
                showToast('Pasted from clipboard');
            } catch (e) {
                el.focus();
                showToast('Click the field and press Ctrl+V to paste', 'info');
            }
        }

        function updateGetKeyLinks() {
            const pairs = [
                ['providerPrimary', 'getKeyPrimary'],
                ['providerFallback1', 'getKeyFallback1'],
                ['providerFallback2', 'getKeyFallback2']
            ];
            pairs.forEach(([selectId, linkId]) => {
                const sel = document.getElementById(selectId);
                const link = document.getElementById(linkId);
                if (!sel || !link) return;
                const provider = sel.value;
                if (provider && PROVIDER_KEY_URLS[provider]) {
                    link.href = PROVIDER_KEY_URLS[provider];
                    link.style.visibility = 'visible';
                } else {
                    link.href = '#';
                    link.style.visibility = 'hidden';
                }
            });
        }

        const PROVIDER_INFO = {
            gemini: { name: 'Gemini', model: 'gemini-2.0-flash', url: (k) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${k}` },
            openai: { name: 'OpenAI', model: 'gpt-4o-mini', url: () => 'https://api.openai.com/v1/chat/completions' },
            grok: { name: 'Grok', model: 'grok-3-mini', url: () => 'https://api.x.ai/v1/chat/completions' },
            claude: { name: 'Claude', model: 'claude-3-5-haiku', url: () => 'https://api.anthropic.com/v1/messages' },
            openrouter: { name: 'OpenRouter', model: 'google/gemini-2.0-flash', url: () => 'https://openrouter.ai/api/v1/chat/completions' }
        };

        async function callProvider(provider, apiKey, prompt) {
            const info = PROVIDER_INFO[provider];
            if (!info) throw new Error('Unknown provider: ' + provider);

            const opts = { method: 'POST', headers: { 'Content-Type': 'application/json' }, signal: abortController?.signal };

            if (provider === 'gemini') {
                opts.body = JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.8, topP: 0.95, maxOutputTokens: 4096 }
                });
                const res = await fetch(info.url(apiKey), opts);
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data?.error?.message || `API error: ${res.status}`);
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'No content generated.';
            }

            if (provider === 'openai' || provider === 'grok' || provider === 'openrouter') {
                opts.body = JSON.stringify({
                    model: provider === 'openrouter' ? info.model : (provider === 'openai' ? 'gpt-4o-mini' : info.model),
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.8,
                    max_tokens: 4096
                });
                opts.headers['Authorization'] = 'Bearer ' + apiKey;
                if (provider === 'openrouter') opts.headers['HTTP-Referer'] = window.location.origin;
                const res = await fetch(info.url(), opts);
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data?.error?.message || data?.message || `API error: ${res.status}`);
                return data.choices?.[0]?.message?.content || data.choices?.[0]?.text || 'No content generated.';
            }

            if (provider === 'claude') {
                opts.body = JSON.stringify({
                    model: info.model,
                    max_tokens: 4096,
                    messages: [{ role: 'user', content: prompt }]
                });
                opts.headers['x-api-key'] = apiKey;
                opts.headers['anthropic-version'] = '2023-06-01';
                const res = await fetch(info.url(), opts);
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data?.error?.message || `API error: ${res.status}`);
                const text = data.content?.find(c => c.type === 'text')?.text;
                return text || 'No content generated.';
            }

            throw new Error('Provider not implemented: ' + provider);
        }

        // ‚îÄ‚îÄ‚îÄ Unified LLM call with multi-provider fallback ‚îÄ‚îÄ‚îÄ
        async function callGemini(prompt, initialConfig = null) {
            const config = initialConfig || buildProviderConfig();

            if (!config.length) {
                throw new Error("No AI provider configured. Add at least one provider (Gemini, OpenAI, Grok, Claude, or OpenRouter) and API key.");
            }

            let lastError = null;
            const originalTitle = document.getElementById('progressTitle')?.textContent || '';
            const progressEl = document.getElementById('progressTitle');

            for (let cfgIdx = 0; cfgIdx < config.length; cfgIdx++) {
                const { provider, keys } = config[cfgIdx];
                if (!keys.length) continue;

                for (let keyIdx = 0; keyIdx < keys.length; keyIdx++) {
                    const apiKey = keys[keyIdx];
                    const providerName = PROVIDER_INFO[provider]?.name || provider;

                    try {
                        if (cfgIdx > 0 || keyIdx > 0) {
                            showToast(`Trying ${providerName} (fallback ${cfgIdx + 1})...`, 'info');
                            if (progressEl) progressEl.textContent = `Trying ${providerName}...`;
                        }

                        const text = await callProvider(provider, apiKey, prompt);

                        currentProviderIndex = cfgIdx;
                        currentKeyIndex = keyIdx;
                        if (cfgIdx > 0 || keyIdx > 0) {
                            showToast(`Using ${providerName}`, 'success');
                            if (progressEl) progressEl.textContent = originalTitle;
                        }
                        return text;

                    } catch (e) {
                        if (e.name === 'AbortError') throw e;
                        const msg = e.message || '';
                        const isQuota = msg.toLowerCase().includes('quota') || msg.includes('rate') || msg.includes('429');
                        console.warn(`${providerName} failed:`, e);

                        if (isQuota && progressEl) {
                            progressEl.textContent = `${providerName} quota exceeded. Trying next...`;
                        }
                        lastError = e;
                    }
                }
            }

            const finalMsg = lastError?.message || "All providers failed.";
            const tip = config.length > 1
                ? "Try adding more fallback providers (OpenAI, OpenRouter) or wait a few minutes."
                : "Add fallback providers (OpenAI, Grok, OpenRouter) in config ‚Äî app will auto-switch when one hits quota.";
            throw new Error(`${finalMsg}\n\nTIP: ${tip}`);
        }

        // ‚îÄ‚îÄ‚îÄ SerpAPI (App Store Search) ‚îÄ‚îÄ‚îÄ
        async function searchAppStores(query, apiKey) {
            if (!apiKey) return null;
            try {
                const googlePlayUrl = `https://serpapi.com/search.json?engine=google_play&q=${encodeURIComponent(query)}&store=apps&api_key=${apiKey}`;
                const appStoreUrl = `https://serpapi.com/search.json?engine=apple_app_store&term=${encodeURIComponent(query)}&api_key=${apiKey}`;

                const [gpRes, asRes] = await Promise.allSettled([
                    fetch(googlePlayUrl, { signal: abortController?.signal }).then(r => r.json()),
                    fetch(appStoreUrl, { signal: abortController?.signal }).then(r => r.json())
                ]);

                const googlePlayApps = gpRes.status === 'fulfilled' ? (gpRes.value.organic_results || []).slice(0, 10) : [];
                const appStoreApps = asRes.status === 'fulfilled' ? (asRes.value.organic_results || []).slice(0, 10) : [];

                return { googlePlayApps, appStoreApps };
            } catch (e) {
                console.warn('SerpAPI search failed:', e);
                return null;
            }
        }

        // ‚îÄ‚îÄ‚îÄ Build Section Prompts ‚îÄ‚îÄ‚îÄ
        function buildPrompts(userPrompt, appStoreData, previousSections, language = 'English') {
            const langInstr = `\n\nCRITICAL: The entire response must be written in ${language}. All headings, descriptions, tables, and the "Sources & References" section must be in ${language}.`;

            const ctx = (keys) => {
                const parts = keys.filter(k => previousSections[k]).map(k => {
                    const sec = SECTIONS.find(s => s.id === k);
                    return `### ${sec.title}\n${previousSections[k]}`;
                });
                return parts.length ? `\n\nHere is the analysis so far for context:\n${parts.join('\n\n')}` : '';
            };

            const appDataStr = appStoreData ? `
Here is REAL app store data found for this product category:

**Google Play Apps Found:**
${appStoreData.googlePlayApps.map((a, i) => `${i + 1}. ${a.title || 'Unknown'} by ${a.developer || 'Unknown'} ‚Äî Rating: ${a.rating || 'N/A'} (${a.reviews || 'N/A'} reviews) ‚Äî ${a.description?.substring(0, 100) || 'No description'}...`).join('\n')}

**App Store Apps Found:**
${appStoreData.appStoreApps.map((a, i) => `${i + 1}. ${a.title || 'Unknown'} by ${a.developer || 'Unknown'} ‚Äî Rating: ${a.rating || 'N/A'} ‚Äî ${a.description?.substring(0, 100) || 'No description'}...`).join('\n')}

Use this real data to enrich your analysis. Reference actual app names, ratings, and developers.` : '';

            const citationInstruction = `\n\nIMPORTANT: At the end of your response, include a "### Sources & References" section. List all data sources, research reports, industry publications, and references you used or drew upon. Format each as: [Number] Source Name ‚Äî Description/URL. Include at minimum 5-8 credible references (e.g. Statista, App Annie/data.ai, Sensor Tower, Grand View Research, IBISWorld, Crunchbase, industry publications, etc.).`;

            return {
                target_audience: `You are a senior product analyst. Based on this product concept, create a detailed Target Audience & User Personas analysis.

Product concept: "${userPrompt}"

Provide in markdown format:
1. **Primary Target Demographics** ‚Äî age, gender, income, education, location
2. **User Personas** (create 3-4 detailed personas) ‚Äî each with name, age, occupation, pain points, goals, tech behavior, and how they'd use this product
3. **Market Segments** ‚Äî identify 2-3 distinct user segments with size estimates
4. **User Behavior Patterns** ‚Äî when/how/why they'd use this product
5. **Acquisition Channels** ‚Äî where to find these users

Be specific and data-driven. Use markdown tables where appropriate.${citationInstruction}`,

                competitor_list: `You are a senior product analyst. Create a comprehensive competitor list for this product.

Product concept: "${userPrompt}"
${appDataStr}

Provide in markdown format:
1. **Direct Competitors** ‚Äî apps/products that solve the same problem (list 8-12)
2. **Indirect Competitors** ‚Äî apps/products that partially overlap (list 5-8)
3. **Potential Future Competitors** ‚Äî companies that could enter this space

For each competitor, include in a markdown table:
| App Name | Platform | Downloads/Users (est.) | Rating | Pricing | Key Differentiator |

${appStoreData ? 'Incorporate the real app store data provided above. Prioritize real data over estimates.' : 'Estimate based on your knowledge of the market.'}
${ctx(['target_audience'])}${citationInstruction}`,

                competitor_analysis: `You are a senior product analyst. Create a deep-dive competitor analysis.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'competitor_list'])}

Provide in markdown format:
1. **Feature Comparison Matrix** ‚Äî markdown table comparing top 6 competitors across 10+ features (‚úÖ/‚ùå/partial)
2. **Pricing Analysis** ‚Äî detailed pricing comparison table (free tier, premium, enterprise)
3. **Strengths & Weaknesses** ‚Äî for top 5 competitors
4. **User Review Sentiment** ‚Äî summarize what users love/hate about top competitors
5. **Market Positioning Map** ‚Äî describe where competitors sit (premium vs budget, simple vs feature-rich)
6. **Competitive Gaps** ‚Äî opportunities not addressed by current players

Be thorough and analytical. Use tables extensively.${citationInstruction}`,

                market_potential: `You are a senior market analyst. Create a comprehensive market potential analysis.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'competitor_list'])}

Provide in markdown format:
1. **TAM (Total Addressable Market)** ‚Äî global market size with calculation methodology
2. **SAM (Serviceable Addressable Market)** ‚Äî realistic reachable market
3. **SOM (Serviceable Obtainable Market)** ‚Äî realistic 3-year capture target
4. **Market Growth Trends** ‚Äî CAGR, growth drivers, projected trajectory (include numbers)
5. **Geographic Breakdown** ‚Äî market size by region with growth rates
6. **Revenue Potential Scenarios** ‚Äî conservative / moderate / aggressive with assumptions
7. **Market Timing** ‚Äî is now the right time? Why?

Use dollar figures, percentages, and cite industry benchmarks. Include a markdown table for TAM/SAM/SOM breakdown.${citationInstruction}`,

                uvp: `You are a senior product strategist. Define a compelling Unique Value Proposition.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'competitor_list', 'competitor_analysis', 'market_potential'])}

Provide in markdown format:
1. **Core UVP Statement** ‚Äî one powerful sentence
2. **Value Proposition Canvas** ‚Äî customer jobs, pains, gains vs. your product's pain relievers and gain creators
3. **Key Differentiators** ‚Äî 4-6 things that make this product uniquely valuable
4. **Why Now** ‚Äî why this product needs to exist now
5. **Positioning Statement** ‚Äî "For [target] who [need], [product] is a [category] that [benefit]. Unlike [alternatives], we [differentiator]."
6. **Elevator Pitch** ‚Äî 30-second version

Be specific and compelling, not generic.${citationInstruction}`,

                swot: `You are a senior business analyst. Create a thorough SWOT analysis.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'competitor_list', 'competitor_analysis', 'market_potential', 'uvp'])}

Provide in markdown format with a clear SWOT matrix table, then detailed analysis:

1. **SWOT Matrix** ‚Äî markdown table with S/W/O/T quadrants (5-7 items each)
2. **Strengths Deep-Dive** ‚Äî elaborate on each strength
3. **Weaknesses Deep-Dive** ‚Äî elaborate with mitigation strategies
4. **Opportunities Deep-Dive** ‚Äî elaborate with action items
5. **Threats Deep-Dive** ‚Äî elaborate with contingency plans
6. **Strategic Implications** ‚Äî what the SWOT tells us about overall strategy
7. **Priority Actions** ‚Äî top 5 actions based on SWOT findings${citationInstruction}`,

                features: `You are a senior product manager. Define the product features.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'competitor_analysis', 'uvp', 'swot'])}

Provide in markdown format:
1. **Core Features (MVP)** ‚Äî the must-have features for launch (8-12 features)
   - List each feature on its own line starting with "- " followed by the feature name, then " ‚Äî " and the description (e.g., "- User Authentication ‚Äî Secure login via email/social")
   - Include: feature name, description, user benefit, priority (P0/P1/P2), estimated complexity
2. **Premium/Advanced Features** ‚Äî features for paid tiers (5-8 features)
3. **Nice-to-Have Features** ‚Äî future consideration (5-8 features)
4. **Feature Prioritization Matrix** ‚Äî markdown table: Feature | Impact | Effort | Priority
5. **Technical Requirements** ‚Äî key tech considerations for core features
6. **Feature Differentiators** ‚Äî which features set this apart from competitors

Use markdown tables for the prioritization matrix. Be specific about what each feature does.${citationInstruction}`,

                monetization: `You are a senior monetization strategist. Design the monetization strategy.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'competitor_analysis', 'market_potential', 'features'])}

Provide in markdown format:
1. **Revenue Model** ‚Äî primary and secondary revenue streams
2. **Pricing Tiers** ‚Äî detailed breakdown (Free / Premium / Pro / Enterprise) with exact prices and what's included in each
3. **Pricing Comparison vs Competitors** ‚Äî markdown table
4. **Revenue Projections** ‚Äî Year 1-3 with assumptions (users, conversion rates, ARPU)
5. **Customer Lifetime Value (CLV)** ‚Äî estimated CLV by segment
6. **Customer Acquisition Cost (CAC)** ‚Äî target CAC and channels
7. **Unit Economics** ‚Äî CLV:CAC ratio, payback period, margins
8. **Pricing Psychology** ‚Äî specific pricing tactics to use

Include detailed financial projections in markdown tables.${citationInstruction}`,

                kpis: `You are a senior data/analytics lead. Define the key metrics and KPIs.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'features', 'monetization'])}

Provide in markdown format:
1. **North Star Metric** ‚Äî the single most important metric and why
2. **Acquisition Metrics** ‚Äî CAC, install rate, organic vs paid split, channel effectiveness
3. **Activation Metrics** ‚Äî onboarding completion, time to value, setup rate
4. **Engagement Metrics** ‚Äî DAU/MAU, session duration, feature adoption, stickiness ratio
5. **Retention Metrics** ‚Äî D1/D7/D30 retention, churn rate, cohort analysis approach
6. **Revenue Metrics** ‚Äî ARPU, ARPPU, MRR, conversion rate, LTV
7. **KPI Dashboard** ‚Äî markdown table showing metric, target, measurement frequency
8. **Leading vs Lagging Indicators** ‚Äî which metrics predict future success

Include specific target numbers and benchmarks for the industry.${citationInstruction}`,

                roadmap: `You are a senior product strategist. Create a detailed product roadmap.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'features', 'market_potential', 'monetization', 'kpis'])}

Provide in markdown format:
1. **Pre-Launch Phase (Month 1-2)** ‚Äî research, validation, prototype
2. **MVP Launch (Month 3-4)** ‚Äî core features, soft launch, initial users
3. **Growth Phase (Month 5-8)** ‚Äî feature expansion, marketing push, paid features
4. **Scale Phase (Month 9-12)** ‚Äî optimization, new markets, partnerships
5. **Year 2 Vision** ‚Äî major milestones and strategic goals

For each phase include:
- Key deliverables (specific features)
- Success criteria (metrics)
- Resources needed
- Key risks and mitigations
- Dependencies

Use a markdown table for the timeline overview. Be specific about what gets built when.${citationInstruction}`,

                risks: `You are a senior risk analyst. Create a comprehensive risk assessment.

Product concept: "${userPrompt}"
${ctx(['target_audience', 'competitor_analysis', 'market_potential', 'swot', 'monetization', 'roadmap'])}

Provide in markdown format:
1. **Risk Matrix** ‚Äî markdown table: Risk | Likelihood (1-5) | Impact (1-5) | Risk Score | Mitigation
2. **Market Risks** ‚Äî competition, timing, demand uncertainty
3. **Technical Risks** ‚Äî scalability, security, performance, reliability
4. **Financial Risks** ‚Äî funding, burn rate, revenue delays
5. **Regulatory & Legal Risks** ‚Äî compliance, data privacy, IP
6. **Operational Risks** ‚Äî team, execution, vendor dependencies
7. **Reputational Risks** ‚Äî brand, PR, user trust
8. **Contingency Plans** ‚Äî for top 5 risks, detailed plan B
9. **Risk Monitoring Plan** ‚Äî how to track and respond to emerging risks

Be specific to this product, not generic. Rate each risk numerically.${citationInstruction}${langInstr}`
            };
        }

        // ‚îÄ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ‚îÄ
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function createSectionCard(section, index) {
            return `
    <div class="section-card expanded" id="card-${section.id}" style="animation-delay: ${index * 0.05}s">
        <div class="section-card__header" onclick="toggleSection('${section.id}')">
            <div class="section-card__header-left">
                <div class="section-card__icon" style="background: ${section.color}15; color: ${section.color}">
                    ${section.icon}
                </div>
                <div>
                    <div class="section-card__number">SECTION ${index + 1} OF 11</div>
                    <div class="section-card__title">${section.title}</div>
                </div>
            </div>
            <div class="section-card__header-right">
                <div class="section-card__chevron">‚ñº</div>
            </div>
        </div>
        <div class="section-card__body">
            <div class="section-card__content" id="content-${section.id}">
                <div class="section-card__edit-indicator" id="editind-${section.id}">‚úèÔ∏è Editing ‚Äî click outside to save</div>
                <div class="markdown-body">
                    <div class="skeleton skeleton-line" style="width:100%"></div>
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                </div>
            </div>
            <div class="section-card__editor" id="editor-${section.id}">
                <textarea id="editarea-${section.id}"></textarea>
            </div>
            <div class="section-card__actions">
                <button class="btn btn--secondary btn--small" onclick="toggleEdit('${section.id}')" id="editbtn-${section.id}">
                    ‚úèÔ∏è Edit
                </button>
                <button class="btn btn--secondary btn--small" onclick="regenerateSection('${section.id}')">
                    üîÑ Regenerate
                </button>
                ${section.id === 'features' ? `
                <button class="btn btn--secondary btn--small" onclick="openFeatureReviewModal()" title="Mark features that passed review">
                    ‚úì Pass Review
                </button>
                <button class="btn btn--primary btn--small" onclick="generateUserFlow()" id="generateUserFlowBtn" title="Generate user flow from features marked as pass review">
                    üîÑ Generate User Flow
                </button>
                ` : ''}
            </div>
        </div>
    </div>`;
        }

        function updateProgress(currentIndex, status = 'active') {
            const fill = document.getElementById('progressFill');
            const count = document.getElementById('progressCount');
            const steps = document.querySelectorAll('.progress-step');

            const pct = ((currentIndex + (status === 'done' ? 1 : 0.5)) / SECTIONS.length) * 100;
            fill.style.width = `${pct}%`;
            count.textContent = `${status === 'done' ? currentIndex + 1 : currentIndex} / ${SECTIONS.length}`;

            steps.forEach((step, i) => {
                step.className = 'progress-step';
                if (i < currentIndex) step.classList.add('done');
                else if (i === currentIndex) step.classList.add(status);
            });
        }

        // ‚îÄ‚îÄ‚îÄ Core Analysis Pipeline ‚îÄ‚îÄ‚îÄ
        async function startAnalysis() {
            const serpKey = document.getElementById('serpKey').value.trim();
            const userPrompt = document.getElementById('promptInput').value.trim();
            providerConfig = buildProviderConfig();

            if (!providerConfig.length) {
                showToast('Please add at least one AI provider and API key (Gemini, OpenAI, Grok, etc.).', 'error');
                return;
            }
            if (!userPrompt) { showToast('Please enter a product prompt.', 'error'); return; }

            currentProviderIndex = 0;
            currentKeyIndex = 0;

            // Save to localStorage
            localStorage.setItem('pa_provider_primary', document.getElementById('providerPrimary')?.value || 'gemini');
            localStorage.setItem('pa_key_primary', document.getElementById('keyPrimary')?.value || '');
            localStorage.setItem('pa_provider_fb1', document.getElementById('providerFallback1')?.value || '');
            localStorage.setItem('pa_key_fb1', document.getElementById('keyFallback1')?.value || '');
            localStorage.setItem('pa_provider_fb2', document.getElementById('providerFallback2')?.value || '');
            localStorage.setItem('pa_key_fb2', document.getElementById('keyFallback2')?.value || '');
            localStorage.setItem('pa_serp_key', serpKey);

            isGenerating = true;
            abortController = new AbortController();
            analysisData = {};
            userFlowData = null;
            const ufActions = document.getElementById('userFlowActions');
            if (ufActions) ufActions.style.display = 'none';

            // UI Updates
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-flex';
            document.getElementById('progressTracker').classList.add('active');
            document.getElementById('results').classList.add('active');

            // Build progress steps
            const stepsEl = document.getElementById('progressSteps');
            stepsEl.innerHTML = SECTIONS.map(s => `<div class="progress-step">${s.icon} ${s.title.split('(')[0].trim()}</div>`).join('');

            // Build section cards
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = SECTIONS.map((s, i) => createSectionCard(s, i)).join('');

            // Scroll to progress
            document.getElementById('progressTracker').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Step 0: Fetch app store data (if SerpAPI key provided)
            let appStoreData = null;
            if (serpKey) {
                document.getElementById('progressTitle').textContent = 'üîç Searching app stores for real competitor data...';
                try {
                    // Extract a search query from the prompt
                    const searchQuery = await callGemini(
                        `Extract a concise 2-4 word app store search query from this product concept. Return ONLY the search query, nothing else: "${userPrompt}"`
                    );
                    appStoreData = await searchAppStores(searchQuery.trim(), serpKey);
                    if (appStoreData) {
                        showToast(`Found ${appStoreData.googlePlayApps.length} Google Play + ${appStoreData.appStoreApps.length} App Store results`);
                    }
                } catch (e) {
                    console.warn('App store search skipped:', e);
                }
            }

            // Generate each section sequentially
            const lang = document.getElementById('targetLanguage').value;
            const prompts = buildPrompts(userPrompt, appStoreData, analysisData, lang);

            for (let i = 0; i < SECTIONS.length; i++) {
                if (!isGenerating) break;

                const section = SECTIONS[i];
                document.getElementById('progressTitle').textContent = `Generating: ${section.title}...`;
                updateProgress(i, 'active');

                // Scroll to current card
                const card = document.getElementById(`card-${section.id}`);
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });

                try {
                    // Rebuild prompts with accumulated context
                    const freshPrompts = buildPrompts(userPrompt, appStoreData, analysisData, lang);
                    const content = await callGemini(freshPrompts[section.id]);

                    analysisData[section.id] = content;

                    // Render content
                    const contentEl = document.getElementById(`content-${section.id}`);
                    contentEl.innerHTML = `<div class="section-card__edit-indicator" id="editind-${section.id}">‚úèÔ∏è Editing ‚Äî click outside to save</div><div class="markdown-body">${marked.parse(content)}</div>`;

                    // Store raw in editor textarea
                    document.getElementById(`editarea-${section.id}`).value = content;

                    updateProgress(i, 'done');

                } catch (e) {
                    if (e.name === 'AbortError') break;

                    const contentEl = document.getElementById(`content-${section.id}`);
                    contentEl.innerHTML = `<div class="markdown-body" style="color:var(--danger)">‚ö†Ô∏è Failed to generate: ${e.message}</div>`;
                    analysisData[section.id] = `> Error: ${e.message}`;

                    const steps = document.querySelectorAll('.progress-step');
                    steps[i].classList.add('error');

                    showToast(`Error in ${section.title}: ${e.message}`, 'error');
                }

                // Small delay between API calls to avoid rate limiting
                if (i < SECTIONS.length - 1 && isGenerating) {
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            // Done
            isGenerating = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('progressTitle').textContent = '‚úÖ Analysis complete!';
            document.getElementById('progressFill').style.width = '100%';

            if (Object.keys(analysisData).length > 0) {
                showToast('Analysis complete! All sections generated.');
                document.getElementById('qaContainer').classList.add('active');
            }
        }

        function stopAnalysis() {
            isGenerating = false;
            if (abortController) abortController.abort();
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('progressTitle').textContent = '‚èπ Analysis stopped';
            showToast('Analysis stopped by user.', 'error');
        }

        // ‚îÄ‚îÄ‚îÄ Section Actions ‚îÄ‚îÄ‚îÄ
        function toggleSection(id) {
            const card = document.getElementById(`card-${id}`);
            card.classList.toggle('expanded');
        }

        function toggleEdit(id) {
            const card = document.getElementById(`card-${id}`);
            const btn = document.getElementById(`editbtn-${id}`);
            const contentEl = document.getElementById(`content-${id}`);
            const mdBody = contentEl.querySelector('.markdown-body');

            if (card.classList.contains('editing')) {
                // Save edits ‚Äî capture the edited HTML and store
                if (mdBody) {
                    mdBody.contentEditable = 'false';
                    // Update the raw markdown data from the edited HTML
                    // We keep the HTML as the source of truth after editing
                    analysisData[id] = mdBody.innerText;
                }
                card.classList.remove('editing');
                btn.innerHTML = '‚úèÔ∏è Edit';
                showToast('Changes saved!');
            } else {
                // Enter inline edit mode
                if (mdBody) {
                    mdBody.contentEditable = 'true';
                    mdBody.focus();
                }
                card.classList.add('editing');
                btn.innerHTML = 'üíæ Save';
            }
        }

        async function regenerateSection(id) {
            const config = buildProviderConfig();
            const userPrompt = document.getElementById('promptInput').value.trim();

            if (!config.length || !userPrompt) {
                showToast('AI provider key and prompt required.', 'error');
                return;
            }

            const section = SECTIONS.find(s => s.id === id);
            const contentEl = document.getElementById(`content-${id}`);
            const card = document.getElementById(`card-${id}`);

            // Exit edit mode if active
            if (card.classList.contains('editing')) {
                card.classList.remove('editing');
                document.getElementById(`editbtn-${id}`).innerHTML = '‚úèÔ∏è Edit';
            }

            // Show loading
            contentEl.innerHTML = `<div class="markdown-body" style="display:flex;align-items:center;gap:10px;"><div class="spinner"></div> Regenerating ${section.title}...</div>`;

            try {
                abortController = new AbortController();
                const lang = document.getElementById('targetLanguage').value;
                const freshPrompts = buildPrompts(userPrompt, null, analysisData, lang);
                const content = await callGemini(freshPrompts[id]);

                analysisData[id] = content;
                contentEl.innerHTML = `<div class="section-card__edit-indicator" id="editind-${id}">‚úèÔ∏è Editing ‚Äî click outside to save</div><div class="markdown-body">${marked.parse(content)}</div>`;
                document.getElementById(`editarea-${id}`).value = content;
                showToast(`${section.title} regenerated!`);
            } catch (e) {
                contentEl.innerHTML = `<div class="markdown-body" style="color:var(--danger)">‚ö†Ô∏è Regeneration failed: ${e.message}</div>`;
                showToast(`Error: ${e.message}`, 'error');
            }
        }

        // ‚îÄ‚îÄ‚îÄ Q&A Refinement ‚îÄ‚îÄ‚îÄ
        async function applyRefinement() {
            const userInput = document.getElementById('qaInput').value.trim();
            const messagesEl = document.getElementById('qaMessages');
            const statusEl = document.getElementById('refiningStatus');
            const refineBtn = document.getElementById('refineBtn');

            if (buildProviderConfig().length === 0 || !userInput) return;

            // Add user message to UI
            const userMsg = document.createElement('div');
            userMsg.className = 'message message--user';
            userMsg.textContent = userInput;
            messagesEl.appendChild(userMsg);
            document.getElementById('qaInput').value = '';
            messagesEl.scrollTop = messagesEl.scrollHeight;

            // UI State
            statusEl.classList.add('active');
            refineBtn.disabled = true;

            try {
                const lang = document.getElementById('targetLanguage').value;
                const context = SECTIONS.filter(s => analysisData[s.id]).map(s => {
                    return `SECTION: ${s.id} (${s.title})\nCONTENT:\n${analysisData[s.id]}`;
                }).join('\n\n---\n\n');

                const refinementPrompt = `
You are an expert product analyst helping a user refine a product analysis report.
Target Language: ${lang}
Current User Prompt: "${document.getElementById('promptInput').value.trim()}"

CURRENT ANALYSIS CONTENT:
${context}

USER REQUEST: "${userInput}"

INSTRUCTIONS:
1. Address the user's request in ${lang}. You can provide an answer to a question AND/OR update specific sections of the analysis.
2. If you decide to update sections, return the FULL NEW CONTENT for those sections in ${lang}.
3. Your response must be a valid JSON object with the following format:
{
  "answer": "Your natural language response to the user's query in ${lang}.",
  "updates": {
    "section_id": "Fully updated markdown content for this section in ${lang}",
    ...
  }
}
4. Only include sections in "updates" that actually need changing.
5. In your "answer", explain what changes you made.
6. Ensure the markdown you return is high quality and follows the existing style.
7. CRITICAL: Do NOT use any language other than ${lang} in your JSON response contents.

RESPONSE FORMAT: (Only return the JSON object)
`;

                const rawResponse = await callGemini(refinementPrompt);

                // Try to parse JSON. Sometimes Gemini might wrap it in markdown blocks.
                let jsonStr = rawResponse.trim();
                if (jsonStr.startsWith('```json')) jsonStr = jsonStr.replace(/```json|```/g, '').trim();
                if (jsonStr.startsWith('{')) {
                    const result = JSON.parse(jsonStr);

                    // Add AI answer
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'message message--ai';
                    aiMsg.innerHTML = marked.parse(result.answer || "Refinement complete.");
                    messagesEl.appendChild(aiMsg);

                    // Apply updates
                    if (result.updates) {
                        for (const [sectionId, newContent] of Object.entries(result.updates)) {
                            if (analysisData[sectionId] !== undefined) {
                                analysisData[sectionId] = newContent;
                                const contentEl = document.getElementById(`content-${sectionId}`);
                                if (contentEl) {
                                    contentEl.innerHTML = `<div class="section-card__edit-indicator" id="editind-${sectionId}">‚úèÔ∏è Editing ‚Äî click outside to save</div><div class="markdown-body">${marked.parse(newContent)}</div>`;
                                }
                                const editArea = document.getElementById(`editarea-${sectionId}`);
                                if (editArea) editArea.value = newContent;

                                // Visual feedback on the updated card
                                const card = document.getElementById(`card-${sectionId}`);
                                if (card) {
                                    card.style.borderColor = 'var(--accent)';
                                    setTimeout(() => card.style.borderColor = 'var(--border)', 2000);
                                }
                            }
                        }
                        showToast(`Updated ${Object.keys(result.updates).length} sections!`);
                    }
                } else {
                    // Fallback for non-JSON response
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'message message--ai';
                    aiMsg.innerHTML = marked.parse(rawResponse);
                    messagesEl.appendChild(aiMsg);
                }

            } catch (e) {
                console.error(e);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message message--ai';
                errorMsg.style.color = 'var(--danger)';
                errorMsg.textContent = `Error: ${e.message}`;
                messagesEl.appendChild(errorMsg);
                showToast('Refinement failed.', 'error');
            } finally {
                statusEl.classList.remove('active');
                refineBtn.disabled = false;
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }
        }

        // ‚îÄ‚îÄ‚îÄ Feature Review & User Flow ‚îÄ‚îÄ‚îÄ
        function parseFeaturesFromContent() {
            const content = analysisData.features || '';
            const features = [];
            const seen = new Set();

            // Match list items: "- Feature name" or "1. Feature name" or "* Feature name"
            const listRegex = /^[\s]*[-*]?\s*\d*\.?\s*\*?\*?(.+?)\*?\*?(?:\s*[‚Äî\-‚Äì]\s*.+)?$/gm;
            // Match table rows: | Feature | ...
            const tableRegex = /^\|\s*\*?\*?(.+?)\*?\*?\s*\|/gm;

            const extract = (match) => {
                let name = match.replace(/^\s*[-*]\s*|\d+\.\s*/g, '').replace(/\*\*/g, '').trim();
                // Take first part before dash/colon for cleaner name
                name = name.split(/\s*[‚Äî\-‚Äì:]\s*/)[0].trim();
                if (name && name.length > 2 && name.length < 80 && !seen.has(name.toLowerCase())) {
                    seen.add(name.toLowerCase());
                    return name;
                }
                return null;
            };

            let m;
            const lines = content.split('\n');
            for (const line of lines) {
                // Skip headers, sources, empty
                if (/^#{1,6}\s|^###\s|^Sources|^-{3,}$/.test(line) || line.trim().length < 5) continue;

                // List item
                const listMatch = line.match(/^[\s]*[-*]?\s*(\d+\.)?\s*\*?(.+?)(?:\*?\s*[‚Äî\-‚Äì]\s*.+)?$/);
                if (listMatch && listMatch[2]) {
                    let name = listMatch[2].replace(/\*\*/g, '').trim().split(/\s*[‚Äî\-‚Äì:]\s*/)[0].trim();
                    if (name.length > 3 && name.length < 80 && !seen.has(name.toLowerCase())) {
                        seen.add(name.toLowerCase());
                        features.push(name);
                    }
                    continue;
                }

                // Table row (skip header separator)
                if (line.startsWith('|') && !line.match(/^\|[-:\s|]+\|$/)) {
                    const cells = line.split('|').map(c => c.trim()).filter(Boolean);
                    if (cells[0] && !/feature|name|description/i.test(cells[0])) {
                        let name = cells[0].replace(/\*\*/g, '').trim();
                        if (name.length > 2 && name.length < 80 && !seen.has(name.toLowerCase())) {
                            seen.add(name.toLowerCase());
                            features.push(name);
                        }
                    }
                }
            }

            return features;
        }

        function openFeatureReviewModal() {
            const features = parseFeaturesFromContent();
            const modal = document.getElementById('featureReviewModal');
            const listEl = document.getElementById('featureReviewList');

            if (features.length === 0) {
                listEl.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No features detected. Run analysis first or ensure the Product Features section has list/table content.</p>';
            } else {
                listEl.innerHTML = features.map((f, i) => `
                    <div class="feature-review-item ${featuresPassedReview.includes(f) ? 'passed' : ''}">
                        <input type="checkbox" id="feat-${i}" data-feature="${f.replace(/"/g, '&quot;')}" ${featuresPassedReview.includes(f) ? 'checked' : ''}>
                        <label class="feature-review-item__label" for="feat-${i}">${f.replace(/</g, '&lt;')}</label>
                    </div>
                `).join('');
            }
            modal.classList.add('active');
        }

        function closeFeatureReviewModal() {
            document.getElementById('featureReviewModal').classList.remove('active');
        }

        function confirmFeatureReview() {
            const checkboxes = document.querySelectorAll('#featureReviewList input[type="checkbox"]:checked');
            featuresPassedReview = Array.from(checkboxes).map(cb => cb.dataset.feature || cb.nextElementSibling?.textContent).filter(Boolean);
            closeFeatureReviewModal();
            showToast(`Selected ${featuresPassedReview.length} feature(s) for user flow generation.`);
        }

        function toggleUserFlowSection() {
            const section = document.getElementById('userFlowSection');
            const chevron = document.getElementById('userFlowChevron');
            section.classList.toggle('expanded');
            chevron.style.transform = section.classList.contains('expanded') ? 'rotate(180deg)' : 'none';
        }

        async function generateUserFlow() {
            const config = buildProviderConfig();
            const userPrompt = document.getElementById('promptInput').value.trim();
            const btn = document.getElementById('generateUserFlowBtn');

            if (!config.length) { showToast('Please add an AI provider and API key.', 'error'); return; }
            if (!analysisData.features) { showToast('Generate the Product Features section first.', 'error'); return; }

            let featuresToUse = featuresPassedReview.length > 0 ? featuresPassedReview : parseFeaturesFromContent();
            if (featuresToUse.length === 0) {
                showToast('Mark features as Pass Review first, or ensure the Features section has parseable content.', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            const diagramEl = document.getElementById('userFlowDiagram');
            diagramEl.innerHTML = '<div style="display:flex;align-items:center;gap:12px;color:var(--text-muted);"><div class="spinner"></div> Generating user flow from features...</div>';

            document.getElementById('userFlowSection').classList.add('active');
            document.getElementById('userFlowSection').classList.add('expanded');

            try {
                abortController = new AbortController();
                const lang = document.getElementById('targetLanguage').value;

                const flowPrompt = `You are a senior product designer. Create a product user flow based on these features that passed review.

Product concept: "${userPrompt}"
Features (passed review): ${featuresToUse.join(', ')}

Provide your response as a JSON object with two fields:
1. "mermaid": A Mermaid flowchart diagram showing the user flow. Use flowchart TD or LR. Nodes should represent: entry point, key screens/steps, decisions, and outcomes. Use proper Mermaid syntax. Keep it readable (max ~20 nodes).
2. "description": A markdown description (2-4 paragraphs) explaining the user flow, key steps, and how the features connect.

Example mermaid structure:
flowchart TD
    A[User Opens App] --> B[Onboarding]
    B --> C{First time?}
    C -->|Yes| D[Sign Up]
    C -->|No| E[Login]
    D --> F[Dashboard]
    E --> F
    F --> G[Feature 1]
    
Only return valid JSON, no markdown code fences.`;

                const raw = await callGemini(flowPrompt);
                let jsonStr = raw.trim();
                if (jsonStr.startsWith('```json')) jsonStr = jsonStr.replace(/```json|```/g, '').trim();
                if (jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/```/g, '').trim();

                let result;
                try {
                    result = JSON.parse(jsonStr);
                } catch (parseErr) {
                    // Fallback: treat raw response as description, no diagram
                    diagramEl.innerHTML = '<div class="markdown-body">' + marked.parse(raw) + '</div>';
                    showToast('User flow generated (text only).');
                    return;
                }

                const descHtml = result.description ? marked.parse(result.description) : '';

                let diagramHtml = descHtml;
                if (result.mermaid) {
                    diagramHtml += '<div class="user-flow-diagram mermaid">' + result.mermaid + '</div>';
                }

                diagramEl.innerHTML = diagramHtml;

                if (result.mermaid && typeof mermaid !== 'undefined') {
                    try {
                        mermaid.initialize({ startOnLoad: false, theme: 'dark' });
                        await mermaid.run({ querySelector: '#userFlowDiagram .mermaid', suppressErrors: true });
                    } catch (mr) { console.warn('Mermaid render:', mr); }
                }

                userFlowData = { mermaid: result.mermaid, description: result.description };
                document.getElementById('userFlowActions').style.display = 'flex';
                showToast('User flow generated!');
            } catch (e) {
                console.error(e);
                diagramEl.innerHTML = '<div class="markdown-body" style="color:var(--danger)">‚ö†Ô∏è Failed to generate user flow: ' + (e.message || 'Unknown error') + '</div>';
                showToast('User flow generation failed.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Generate User Flow';
            }
        }

        let figmaSpecContent = null;  // Stores generated Figma design spec HTML

        function exportUserFlowSVG() {
            const svgEl = document.querySelector('#userFlowDiagram svg');
            if (!svgEl) {
                showToast('Generate user flow first or diagram not available.', 'error');
                return;
            }
            const svg = svgEl.outerHTML;
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user-flow-${Date.now()}.svg`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('SVG downloaded! Drag into Figma to import.');
        }

        async function generateFigmaDesignSpec() {
            const config = buildProviderConfig();
            const userPrompt = document.getElementById('promptInput').value.trim();
            const btn = document.getElementById('generateFigmaBtn');

            if (!config.length) { showToast('Please add an AI provider and API key.', 'error'); return; }
            if (!userFlowData && !document.getElementById('userFlowDiagram').innerHTML.trim()) {
                showToast('Generate the user flow first.', 'error');
                return;
            }

            const userFlowDesc = userFlowData?.description || '';
            const features = featuresPassedReview.length > 0 ? featuresPassedReview : parseFeaturesFromContent();

            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            try {
                abortController = new AbortController();
                const lang = document.getElementById('targetLanguage').value;

                const prompt = `You are a senior UX/UI designer creating a Figma-ready design specification.

Product concept: "${userPrompt}"
User flow summary: ${userFlowDesc}
Key features: ${features.join(', ')}

Generate a comprehensive Figma design spec. Return a valid JSON object:
{
  "title": "Product name - Figma Design Spec",
  "frames": [
    {
      "name": "Screen/Frame name",
      "width": 375,
      "height": 812,
      "description": "What this screen shows",
      "components": ["Component1", "Component2"],
      "layout": "Brief layout notes"
    }
  ],
  "designTokens": {
    "colors": { "primary": "#8b5cf6", "..." },
    "typography": { "heading": "24px / Inter / Bold", "..." },
    "spacing": { "xs": 4, "sm": 8, "md": 16 }
  },
  "componentLibrary": ["List", "of", "reusable", "components"],
  "notes": "Additional design guidance"
}

Include 5-12 frames covering: onboarding, main screens, key feature flows. Use mobile-first dimensions (375x812 or 390x844). Be specific. Output ONLY valid JSON.`;

                const raw = await callGemini(prompt);
                let jsonStr = raw.trim();
                if (jsonStr.startsWith('```json')) jsonStr = jsonStr.replace(/```json|```/g, '').trim();
                if (jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/```/g, '').trim();

                const spec = JSON.parse(jsonStr);

                let html = '<h2 style="color:var(--text-primary);margin-bottom:16px;">' + (spec.title || 'Figma Design Spec') + '</h2>';
                if (spec.notes) html += '<p class="markdown-body" style="margin-bottom:20px;">' + spec.notes + '</p>';

                html += '<h3 style="color:var(--accent-light);margin:24px 0 12px;">Frames & Screens</h3>';
                (spec.frames || []).forEach((f, i) => {
                    html += `<div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">
                        <strong>${i + 1}. ${f.name}</strong> <span style="color:var(--text-muted);font-size:12px;">(${f.width || 375}√ó${f.height || 812})</span>
                        <p style="font-size:13px;color:var(--text-secondary);margin:8px 0 0;">${f.description || ''}</p>
                        ${f.components?.length ? '<div style="margin-top:8px;font-size:12px;color:var(--text-muted);">Components: ' + f.components.join(', ') + '</div>' : ''}
                        ${f.layout ? '<div style="margin-top:4px;font-size:12px;">Layout: ' + f.layout + '</div>' : ''}
                    </div>`;
                });

                if (spec.designTokens) {
                    html += '<h3 style="color:var(--accent-light);margin:24px 0 12px;">Design Tokens</h3><pre style="background:var(--bg-secondary);padding:16px;border-radius:8px;font-size:12px;overflow-x:auto;">' + JSON.stringify(spec.designTokens, null, 2) + '</pre>';
                }
                if (spec.componentLibrary?.length) {
                    html += '<h3 style="color:var(--accent-light);margin:24px 0 12px;">Component Library</h3><p class="markdown-body">' + spec.componentLibrary.join(', ') + '</p>';
                }

                figmaSpecContent = html;
                document.getElementById('figmaSpecBody').innerHTML = html;
                document.getElementById('figmaSpecModal').classList.add('active');
                showToast('Figma design spec generated!');
            } catch (e) {
                console.error(e);
                showToast('Failed to generate Figma spec: ' + (e.message || 'Unknown error'), 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìê Generate Figma Design';
            }
        }

        function closeFigmaSpecModal() {
            document.getElementById('figmaSpecModal').classList.remove('active');
        }

        function exportFigmaSpecHTML() {
            if (!figmaSpecContent) return;
            const prompt = document.getElementById('promptInput').value.trim();
            const safePrompt = prompt.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const varMap = { 'bg-secondary':'#12121a','border':'#333','text-primary':'#f0f0f5','text-secondary':'#9898a6','text-muted':'#5a5a6e','accent-light':'#a78bfa' };
            const safeContent = figmaSpecContent.replace(/var\(--([a-z-]+)\)/g, (_, k) => varMap[k] || '#888');
            const fullHtml = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Figma Design Spec</title>' +
                '<style>body{font-family:Inter,sans-serif;background:#0a0a0f;color:#f0f0f5;padding:40px;max-width:800px;margin:0 auto}' +
                'h2{color:#a78bfa}h3{color:#8b5cf6}pre{background:#12121a;color:#9898a6;padding:16px;border-radius:8px}</style></head><body>' +
                '<h1>Figma Design Spec</h1><p><strong>Product:</strong> ' + safePrompt + '</p>' +
                '<p><strong>Generated:</strong> ' + new Date().toLocaleString() + '</p><hr style="border-color:#333;margin:24px 0">' +
                safeContent + '</body></html>';
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'figma-design-spec-' + Date.now() + '.html';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Design spec HTML downloaded!');
        }

        // ‚îÄ‚îÄ‚îÄ Expand / Collapse ‚îÄ‚îÄ‚îÄ
        function expandAll() {
            document.querySelectorAll('.section-card').forEach(c => c.classList.add('expanded'));
        }

        function collapseAll() {
            document.querySelectorAll('.section-card').forEach(c => c.classList.remove('expanded'));
        }

        // ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ
        function exportMarkdown() {
            if (!Object.keys(analysisData).length) {
                showToast('No analysis to export.', 'error');
                return;
            }

            const prompt = document.getElementById('promptInput').value.trim();
            let md = `# Product Analysis Report\n\n`;
            md += `> **Prompt:** ${prompt}\n`;
            md += `> **Generated:** ${new Date().toLocaleString()}\n\n---\n\n`;

            SECTIONS.forEach((section, i) => {
                if (analysisData[section.id]) {
                    md += `## ${i + 1}. ${section.icon} ${section.title}\n\n`;
                    md += analysisData[section.id];
                    md += '\n\n---\n\n';
                }
            });

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `product-analysis-${Date.now()}.md`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Markdown file downloaded!');
        }

        function exportWord() {
            if (!Object.keys(analysisData).length) {
                showToast('No analysis to export.', 'error');
                return;
            }

            const prompt = document.getElementById('promptInput').value.trim();
            const now = new Date().toLocaleString();

            // Build HTML content for all sections
            let sectionsHtml = '';
            SECTIONS.forEach((section, i) => {
                if (analysisData[section.id]) {
                    const contentEl = document.getElementById(`content-${section.id}`);
                    const mdBody = contentEl ? contentEl.querySelector('.markdown-body') : null;
                    const html = mdBody ? mdBody.innerHTML : marked.parse(analysisData[section.id]);
                    sectionsHtml += `
                        <h2 style="color:#4a3590; border-bottom: 2px solid #8b5cf6; padding-bottom: 8px; margin-top: 30px;">
                            ${section.icon} ${i + 1}. ${section.title}
                        </h2>
                        ${html}
                        <br/><hr style="border:none; border-top:1px solid #e0e0e0; margin: 20px 0;"/>
                    `;
                }
            });

            const fullHtml = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8">
<title>Product Analysis Report</title>
<!--[if gte mso 9]>
<xml>
<w:WordDocument>
<w:View>Print</w:View>
<w:Zoom>100</w:Zoom>
</w:WordDocument>
</xml>
<![endif]-->
<style>
    body { font-family: 'Calibri', 'Segoe UI', Arial, sans-serif; color: #222; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 40px; }
    h1 { color: #1a1a2e; font-size: 28px; border-bottom: 3px solid #8b5cf6; padding-bottom: 10px; }
    h2 { color: #4a3590; font-size: 20px; margin-top: 28px; }
    h3 { color: #333; font-size: 16px; }
    h4 { color: #555; font-size: 14px; }
    p { margin: 8px 0; }
    table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; }
    th { background: #f3f0ff; color: #333; padding: 10px 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; }
    td { padding: 8px 12px; border: 1px solid #ddd; }
    tr:nth-child(even) { background: #fafafa; }
    ul, ol { padding-left: 24px; margin: 8px 0; }
    li { margin-bottom: 4px; }
    blockquote { border-left: 3px solid #8b5cf6; padding: 8px 16px; margin: 12px 0; background: #f8f7ff; }
    strong { color: #111; }
    em { color: #6d5bae; }
    code { background: #f0f0f0; padding: 2px 5px; border-radius: 3px; font-size: 12px; }
    a { color: #6d5bae; }
    .cover-info { color: #666; font-size: 14px; margin-bottom: 30px; }
</style>
</head>
<body>
    <h1>üìä Product Analysis Report</h1>
    <div class="cover-info">
        <p><strong>Product Concept:</strong> ${prompt.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
        <p><strong>Generated:</strong> ${now}</p>
        <p><strong>Sections:</strong> ${SECTIONS.filter(s => analysisData[s.id]).length} of ${SECTIONS.length}</p>
    </div>
    <hr style="border:none; border-top:2px solid #8b5cf6; margin: 20px 0;"/>
    ${sectionsHtml}
    <br/>
    <p style="color:#999; font-size:12px; text-align:center;">Generated by Product Analyst Pro</p>
</body>
</html>`;

            const blob = new Blob([fullHtml], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `product-analysis-${Date.now()}.doc`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Word document downloaded!');
        }

        function exportPDF() {
            if (!Object.keys(analysisData).length) {
                showToast('No analysis to export.', 'error');
                return;
            }
            expandAll();
            setTimeout(() => window.print(), 300);
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', () => {
            // Restore saved config
            const keyPrimary = document.getElementById('keyPrimary');
            const providerPrimary = document.getElementById('providerPrimary');
            const keyFb1 = document.getElementById('keyFallback1');
            const providerFb1 = document.getElementById('providerFallback1');
            const keyFb2 = document.getElementById('keyFallback2');
            const providerFb2 = document.getElementById('providerFallback2');
            if (keyPrimary && localStorage.getItem('pa_key_primary')) keyPrimary.value = localStorage.getItem('pa_key_primary');
            if (providerPrimary && localStorage.getItem('pa_provider_primary')) providerPrimary.value = localStorage.getItem('pa_provider_primary');
            if (keyFb1 && localStorage.getItem('pa_key_fb1')) keyFb1.value = localStorage.getItem('pa_key_fb1');
            if (providerFb1 && localStorage.getItem('pa_provider_fb1')) providerFb1.value = localStorage.getItem('pa_provider_fb1');
            if (keyFb2 && localStorage.getItem('pa_key_fb2')) keyFb2.value = localStorage.getItem('pa_key_fb2');
            if (providerFb2 && localStorage.getItem('pa_provider_fb2')) providerFb2.value = localStorage.getItem('pa_provider_fb2');
            const serpEl = document.getElementById('serpKey');
            if (serpEl && localStorage.getItem('pa_serp_key')) serpEl.value = localStorage.getItem('pa_serp_key');
            const langEl = document.getElementById('targetLanguage');
            if (langEl && localStorage.getItem('pa_target_lang')) langEl.value = localStorage.getItem('pa_target_lang');
            // Backward compat: restore old gemini key to primary if no key saved
            if (keyPrimary && !keyPrimary.value && localStorage.getItem('pa_gemini_key')) {
                keyPrimary.value = localStorage.getItem('pa_gemini_key');
                if (providerPrimary) providerPrimary.value = 'gemini';
            }
            updateGetKeyLinks();

            // Handle language change save
            document.getElementById('targetLanguage').addEventListener('change', (e) => {
                localStorage.setItem('pa_target_lang', e.target.value);
            });

            // Keyboard shortcut: Ctrl+Enter to generate
            document.getElementById('promptInput').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    startAnalysis();
                }
            });
        });
    </script>

</body>

</html>